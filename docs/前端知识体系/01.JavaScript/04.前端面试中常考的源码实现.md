---
title: "å‰ç«¯é¢è¯•ä¸­å¸¸è€ƒçš„æºç å®ç°"
date: "2019-03-18"
permalink: "2019-03-18-interview-js-code"
---

ğŸ‘‡ å†…å®¹é€Ÿè§ˆ ğŸ‘‡

- æ‰‹åŠ¨å®ç°`call`/`apply`/`bind`
- å®ç°æ·±æ‹·è´å‡½æ•°
- åŸºäº`ES5`/`ES6`å®ç°åŒå‘ç»‘å®š
- `instanceof`åŸç†ä¸å®ç°
- å®ç°æ”¯æŒç»‘å®šã€è§£ç»‘å’Œæ´¾å‘çš„äº‹ä»¶ç±»

## æ‰‹åŠ¨æ’¸ä¸ª call/apply/bind

> æ„Ÿè°¢ [@purain](https://github.com/purain) çš„æŒ‡æ­£ï¼Œ`call` å’Œ `apply` æ›´å®Œç¾çš„å®ç°è¦å€ŸåŠ© `Symbol`ã€‚å…·ä½“è¯·çœ‹[Issue](https://github.com/dongyuanxin/blog/issues/57)

### å®ç° call

æ¥çœ‹ä¸‹`call`çš„åŸç”Ÿè¡¨ç°å½¢å¼ï¼š

```javascript
function test(arg1, arg2) {
  console.log(arg1, arg2);
  console.log(this.a, this.b);
}

test.call(
  {
    a: "a",
    b: "b"
  },
  1,
  2
);
```

å¥½äº†ï¼Œå¼€å§‹æ‰‹åŠ¨å®ç°æˆ‘ä»¬çš„`call2`ã€‚åœ¨å®ç°çš„è¿‡ç¨‹æœ‰ä¸ªå…³é”®ï¼š

**å¦‚æœä¸€ä¸ªå‡½æ•°ä½œä¸ºä¸€ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œé‚£ä¹ˆé€šè¿‡å¯¹è±¡çš„`.`è¿ç®—ç¬¦è°ƒç”¨æ­¤å‡½æ•°ï¼Œ`this`å°±æ˜¯æ­¤å¯¹è±¡**

```javascript
let obj = {
  a: "a",
  b: "b",
  test: function(arg1, arg2) {
    console.log(arg1, arg2);
    // this.a å°±æ˜¯ a; this.b å°±æ˜¯ b
    console.log(this.a, this.b);
  }
};

obj.test(1, 2);
```

çŸ¥é“äº†å®ç°å…³é”®ï¼Œä¸‹é¢å°±æ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿçš„`call`ï¼š

```javascript
Function.prototype.call2 = function(context) {
  if (typeof this !== "function") {
    throw new TypeError("Error");
  }

  // é»˜è®¤ä¸Šä¸‹æ–‡æ˜¯window
  context = context || window;
  // ä¿å­˜é»˜è®¤çš„fn
  const { fn } = context;

  // å‰é¢è®²çš„å…³é”®ï¼Œå°†å‡½æ•°æœ¬èº«ä½œä¸ºå¯¹è±¡contextçš„å±æ€§è°ƒç”¨ï¼Œè‡ªåŠ¨ç»‘å®šthis
  context.fn = this;
  const args = [...arguments].slice(1);
  const result = context.fn(...args);

  // æ¢å¤é»˜è®¤çš„fn
  context.fn = fn;
  return result;
};

// ä»¥ä¸‹æ˜¯æµ‹è¯•ä»£ç 
function test(arg1, arg2) {
  console.log(arg1, arg2);
  console.log(this.a, this.b);
}

test.call2(
  {
    a: "a",
    b: "b"
  },
  1,
  2
);
```

### å®ç° apply

`apply`å’Œ`call`å®ç°ç±»ä¼¼ï¼Œåªæ˜¯ä¼ å…¥çš„å‚æ•°å½¢å¼æ˜¯æ•°ç»„å½¢å¼ï¼Œè€Œä¸æ˜¯é€—å·åˆ†éš”çš„å‚æ•°åºåˆ—ã€‚

å› æ­¤ï¼Œå€ŸåŠ© es6 æä¾›çš„`...`è¿ç®—ç¬¦ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°æ•°ç»„å’Œå‚æ•°åºåˆ—çš„è½¬åŒ–ã€‚

```javascript
Function.prototype.apply2 = function(context) {
  if (typeof this !== "function") {
    throw new TypeError("Error");
  }

  context = context || window;
  const { fn } = context;

  context.fn = this;
  let result;
  if (Array.isArray(arguments[1])) {
    // é€šè¿‡...è¿ç®—ç¬¦å°†æ•°ç»„è½¬æ¢ä¸ºç”¨é€—å·åˆ†éš”çš„å‚æ•°åºåˆ—
    result = context.fn(...arguments[1]);
  } else {
    result = context.fn();
  }

  context.fn = fn;
  return result;
};

/**
 * ä»¥ä¸‹æ˜¯æµ‹è¯•ä»£ç 
 */

function test(arg1, arg2) {
  console.log(arg1, arg2);
  console.log(this.a, this.b);
}

test.apply2(
  {
    a: "a",
    b: "b"
  },
  [1, 2]
);
```

### å®ç° bind

`bind`çš„å®ç°æœ‰ç‚¹æ„æ€ï¼Œå®ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š

- æœ¬èº«è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œæ‰€ä»¥è¦è€ƒè™‘`new`çš„æƒ…å†µ
- å¯ä»¥â€œä¿ç•™â€å‚æ•°ï¼Œå†…éƒ¨å®ç°äº†å‚æ•°çš„æ‹¼æ¥

```javascript
Function.prototype.bind2 = function(context) {
  if (typeof this !== "function") {
    throw new TypeError("Error");
  }

  const that = this;
  // ä¿ç•™ä¹‹å‰çš„å‚æ•°ï¼Œä¸ºäº†ä¸‹é¢çš„å‚æ•°æ‹¼æ¥
  const args = [...arguments].slice(1);

  return function F() {
    // å¦‚æœè¢«newåˆ›å»ºå®ä¾‹ï¼Œä¸ä¼šè¢«æ”¹å˜ä¸Šä¸‹æ–‡ï¼
    if (this instanceof F) {
      return new that(...args, ...arguments);
    }

    // args.concat(...arguments): æ‹¼æ¥ä¹‹å‰å’Œç°åœ¨çš„å‚æ•°
    // æ³¨æ„ï¼šargumentsæ˜¯ä¸ªç±»Arrayçš„Object, ç”¨è§£æ„è¿ç®—ç¬¦..., ç›´æ¥æ‹¿å€¼æ‹¼æ¥
    return that.apply(context, args.concat(...arguments));
  };
};

/**
 * ä»¥ä¸‹æ˜¯æµ‹è¯•ä»£ç 
 */

function test(arg1, arg2) {
  console.log(arg1, arg2);
  console.log(this.a, this.b);
}

const test2 = test.bind2(
  {
    a: "a",
    b: "b"
  },
  1
); // å‚æ•° 1

test2(2); // å‚æ•° 2
```

## å®ç°æ·±æ‹·è´å‡½æ•°

å®ç°ä¸€ä¸ªå¯¹è±¡çš„æ·±æ‹·è´å‡½æ•°ï¼Œéœ€è¦è€ƒè™‘å¯¹è±¡çš„å…ƒç´ ç±»å‹ä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼š

- åŸºç¡€ç±»å‹ï¼šè¿™ç§æœ€ç®€å•ï¼Œç›´æ¥èµ‹å€¼å³å¯
- å¯¹è±¡ç±»å‹ï¼šé€’å½’è°ƒç”¨æ‹·è´å‡½æ•°
- æ•°ç»„ç±»å‹ï¼šè¿™ç§æœ€éš¾ï¼Œå› ä¸ºæ•°ç»„ä¸­çš„å…ƒç´ å¯èƒ½æ˜¯åŸºç¡€ç±»å‹ã€å¯¹è±¡è¿˜å¯èƒ½æ•°ç»„ï¼Œå› æ­¤è¦ä¸“é—¨åšä¸€ä¸ªå‡½æ•°æ¥å¤„ç†æ•°ç»„çš„æ·±æ‹·è´

```javascript
/**
 * æ•°ç»„çš„æ·±æ‹·è´å‡½æ•°
 * @param {Array} src
 * @param {Array} target
 */
function cloneArr(src, target) {
  for (let item of src) {
    if (Array.isArray(item)) {
      target.push(cloneArr(item, []));
    } else if (typeof item === "object") {
      target.push(deepClone(item, {}));
    } else {
      target.push(item);
    }
  }
  return target;
}

/**
 * å¯¹è±¡çš„æ·±æ‹·è´å®ç°
 * @param {Object} src
 * @param {Object} target
 * @return {Object}
 */
function deepClone(src, target) {
  const keys = Reflect.ownKeys(src);
  let value = null;

  for (let key of keys) {
    value = src[key];

    if (Array.isArray(value)) {
      target[key] = cloneArr(value, []);
    } else if (typeof value === "object") {
      // å¦‚æœæ˜¯å¯¹è±¡è€Œä¸”ä¸æ˜¯æ•°ç»„, é‚£ä¹ˆé€’å½’è°ƒç”¨æ·±æ‹·è´
      target[key] = deepClone(value, {});
    } else {
      target[key] = value;
    }
  }

  return target;
}
```

è¿™æ®µä»£ç æ˜¯ä¸æ˜¯æ¯”ç½‘ä¸Šçœ‹åˆ°çš„å¤šäº†å¾ˆå¤šï¼Ÿå› ä¸ºè€ƒè™‘å¾ˆå‘¨å…¨ï¼Œè¯·çœ‹ä¸‹é¢çš„æµ‹è¯•ç”¨ä¾‹ï¼š

```javascript
// è¿™ä¸ªå¯¹è±¡aæ˜¯ä¸€ä¸ªå›Šæ‹¬ä»¥ä¸Šæ‰€æœ‰æƒ…å†µçš„å¯¹è±¡
let a = {
  age: 1,
  jobs: {
    first: "FE"
  },
  schools: [
    {
      name: "shenda"
    },
    {
      name: "shiyan"
    }
  ],
  arr: [
    [
      {
        value: "1"
      }
    ],
    [
      {
        value: "2"
      }
    ]
  ]
};

let b = {};
deepClone(a, b);

a.jobs.first = "native";
a.schools[0].name = "SZU";
a.arr[0][0].value = "100";

console.log(a.jobs.first, b.jobs.first); // output: native FE
console.log(a.schools[0], b.schools[0]); // output: { name: 'SZU' } { name: 'shenda' }
console.log(a.arr[0][0].value, b.arr[0][0].value); // output: 100 1
console.log(Array.isArray(a.arr[0])); // output: true
```

çœ‹åˆ°æµ‹è¯•ç”¨ä¾‹ï¼Œåº”è¯¥ä¼šæœ‰äººå¥‡æ€ªä¸ºä»€ä¹ˆæœ€åè¦è¾“å‡º`Array.isArray(a.arr[0])`ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºç½‘ä¸Šå¾ˆå¤šå®ç°æ–¹æ³•æ²¡æœ‰é’ˆå¯¹ array åšå¤„ç†ï¼Œç›´æ¥å°†å…¶å½“æˆ objectï¼Œ**è¿™æ ·æ‹·è´åè™½ç„¶å€¼æ²¡é—®é¢˜ï¼Œä½†æ˜¯ array çš„å…ƒç´ ä¼šè¢«è½¬åŒ–ä¸º object**ã€‚è¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„åšæ³•ã€‚

è€Œä¸Šé¢æ‰€è¯´çš„æ·±æ‹·è´å‡½æ•°å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

## åŸºäº ES5/ES6 å®ç°â€œåŒå‘ç»‘å®šâ€

è¦æƒ³å®ç°ï¼Œå°±è¦å…ˆçœ‹çœ‹ä»€ä¹ˆæ˜¯â€œåŒå‘æ•°æ®ç»‘å®šâ€ï¼Œå®ƒå’Œâ€œå•å‘æ•°æ®ç»‘å®šâ€æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿè¿™æ ·æ‰èƒ½çŸ¥é“è¦å®ç°ä»€ä¹ˆæ•ˆæœå˜›ã€‚

**åŒå‘ç»‘å®š**ï¼šè§†å›¾ï¼ˆViewï¼‰çš„å˜åŒ–èƒ½å®æ—¶è®©æ•°æ®æ¨¡å‹ï¼ˆModelï¼‰å‘ç”Ÿå˜åŒ–ï¼Œè€Œæ•°æ®çš„å˜åŒ–ä¹Ÿèƒ½å®æ—¶æ›´æ–°åˆ°è§†å›¾å±‚ã€‚

**å•å‘æ•°æ®ç»‘å®š**ï¼šåªæœ‰ä»æ•°æ®åˆ°è§†å›¾è¿™ä¸€æ–¹å‘çš„å…³ç³»ã€‚

### ES5 çš„ Object.defineProperty

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script>
      const obj = {
        value: ""
      };

      function onKeyUp(event) {
        obj.value = event.target.value;
      }

      // å¯¹ obj.value è¿›è¡Œæ‹¦æˆª
      Object.defineProperty(obj, "value", {
        get: function() {
          return value;
        },
        set: function(newValue) {
          value = newValue;
          document.querySelector("#value").innerHTML = newValue; // æ›´æ–°è§†å›¾å±‚
          document.querySelector("input").value = newValue; // æ•°æ®æ¨¡å‹æ”¹å˜
        }
      });
    </script>
  </head>
  <body>
    <p>å€¼æ˜¯ï¼š<span id="value"></span></p>
    <input type="text" onkeyup="onKeyUp(event)" />
  </body>
</html>
```

### ES6 çš„ Proxy

éšç€ï¼Œvue3.0 æ”¾å¼ƒæ”¯æŒäº† IE æµè§ˆå™¨ã€‚è€Œä¸”`Proxy`å…¼å®¹æ€§è¶Šæ¥è¶Šå¥½ï¼Œèƒ½æ”¯æŒ 13 ç§åŠ«æŒæ“ä½œã€‚

å› æ­¤ï¼Œvue3.0 é€‰æ‹©ä½¿ç”¨`Proxy`æ¥å®ç°åŒå‘æ•°æ®ç»‘å®šï¼Œè€Œä¸å†ä½¿ç”¨`Object.defineProperty`ã€‚

```javascript
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script>
    const obj = {}

    const newObj = new Proxy(obj, {
      get: function(target, key, receiver) {
        return Reflect.get(target, key, receiver)
      },
      set: function(target, key, value, receiver) {
        if(key === 'value') {
          document.querySelector('#value').innerHTML = value
          document.querySelector('input').value = value
        }
        return Reflect.set(target, key, value, receiver)
      }
    })

    function onKeyUp(event) {
      newObj.value = event.target.value
    }

  </script>
</head>
<body>
  <p>
    å€¼æ˜¯ï¼š<span id="value"></span>
  </p>
  <input type="text" onkeyup="onKeyUp(event)">
</body>
</html>
```

## instanceof åŸç†ä¸å®ç°

`instanceof`æ˜¯é€šè¿‡åŸå‹é“¾æ¥è¿›è¡Œåˆ¤æ–­çš„ï¼Œæ‰€ä»¥åªè¦ä¸æ–­åœ°é€šè¿‡è®¿é—®`__proto__`ï¼Œå°±å¯ä»¥æ‹¿åˆ°æ„é€ å‡½æ•°çš„åŸå‹`prototype`ã€‚ç›´åˆ°`null`åœæ­¢ã€‚

```javascript
/**
 * åˆ¤æ–­leftæ˜¯ä¸æ˜¯rightç±»å‹çš„å¯¹è±¡
 * @param {*} left
 * @param {*} right
 * @return {Boolean}
 */
function instanceof2(left, right) {
  let prototype = right.prototype;

  // æ²¿ç€leftçš„åŸå‹é“¾, çœ‹çœ‹æ˜¯å¦æœ‰ä½•prototypeç›¸ç­‰çš„èŠ‚ç‚¹
  left = left.__proto__;
  while (1) {
    if (left === null || left === undefined) {
      return false;
    }
    if (left === prototype) {
      return true;
    }
    left = left.__proto__;
  }
}

/**
 * æµ‹è¯•ä»£ç 
 */

console.log(instanceof2([], Array)); // output: true

function Test() {}
let test = new Test();
console.log(instanceof2(test, Test)); // output: true
```

## å®ç°æ”¯æŒç»‘å®šã€è§£ç»‘å’Œæ´¾å‘çš„äº‹ä»¶ç±»

**å®ç°æ€è·¯**ï¼šè¿™é‡Œæ¶‰åŠäº†â€œè®¢é˜…/å‘å¸ƒæ¨¡å¼â€çš„ç›¸å…³çŸ¥è¯†ã€‚å‚è€ƒ`addEventListener(type, func)`å’Œ`removeEventListener(type, func)`çš„å…·ä½“æ•ˆæœæ¥å®ç°å³å¯ã€‚

```javascript
// æ•°ç»„ç½®ç©ºï¼š
// arr = []; arr.length = 0; arr.splice(0, arr.length)
class Event {
  constructor() {
    this._cache = {};
  }

  // æ³¨å†Œäº‹ä»¶ï¼šå¦‚æœä¸å­˜åœ¨æ­¤ç§typeï¼Œåˆ›å»ºç›¸å…³æ•°ç»„
  on(type, callback) {
    this._cache[type] = this._cache[type] || [];
    let fns = this._cache[type];
    if (fns.indexOf(callback) === -1) {
      fns.push(callback);
    }
    return this;
  }

  // è§¦å‘äº‹ä»¶ï¼šå¯¹äºä¸€ä¸ªtypeä¸­çš„æ‰€æœ‰äº‹ä»¶å‡½æ•°ï¼Œå‡è¿›è¡Œè§¦å‘
  trigger(type, ...data) {
    let fns = this._cache[type];
    if (Array.isArray(fns)) {
      fns.forEach(fn => {
        fn(...data);
      });
    }
    return this;
  }

  // åˆ é™¤äº‹ä»¶ï¼šåˆ é™¤äº‹ä»¶ç±»å‹å¯¹åº”çš„array
  off(type, callback) {
    let fns = this._cache[type];
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨typeçš„äº‹ä»¶ç»‘å®š
    if (Array.isArray(fns)) {
      if (callback) {
        // å¸è½½æŒ‡å®šçš„å›è°ƒå‡½æ•°
        let index = fns.indexOf(callback);
        if (index !== -1) {
          fns.splice(index, 1);
        }
      } else {
        // å…¨éƒ¨æ¸…ç©º
        fns = [];
      }
    }
    return this;
  }
}

// ä»¥ä¸‹æ˜¯æµ‹è¯•å‡½æ•°

const event = new Event();
event
  .on("test", a => {
    console.log(a);
  })
  .trigger("test", "hello");
```
